<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add bird</title>
</head>
<body>
<h1>Add a new bird</h1>
<form id="form-container" method="POST">
    {% csrf_token %}
    {{ bird_formset.management_form }}
    {% for form in bird_formset %}
        <div class="bird-form">
            {{ form.as_p }}
        </div>
    {% endfor %}
    <button id="add-form" type="button">Add Another Bird</button>
    <button type="submit">Create Birds</button>
</form>

<script>
    let birdForm = document.querySelectorAll(".bird-form")
    let container = document.querySelector("#form-container")
    let addButton = document.querySelector("#add-form")
    let totalForms = document.querySelector("#id_form-TOTAL_FORMS")

    let formNum = birdForm.length - 1
    addButton.addEventListener('click', addForm)

    function addForm(e) {
        e.preventDefault()

        let newForm = birdForm[0].cloneNode(true)
        let formRegex = RegExp(`form-(\\d){1}-`, 'g')

        formNum++
        newForm.innerHTML = newForm.innerHTML.replace(formRegex, `form-${formNum}-`)
        container.insertBefore(newForm, addButton)

        totalForms.setAttribute('value', `${formNum + 1}`)
    }


    function Formset(element) {
        /*
          Dynamic Formset handler for Django formsets.

        Events:

          * init.formset
          * add-form.formset
          * remove-form.formset
          * renumber-form.formset

        */
        if (!(this instanceof Formset)) {
            return new Formset(element);
        }
        var formset = this;
        var emptyForm = element.querySelector('.empty-form').firstElementChild;
        var formsList = element.querySelector('.forms');

        var initialForms = element.querySelector('[name$=INITIAL_FORM_COUNT]');
        var totalForms = element.querySelector('[name$=TOTAL_FORM_COUNT]');
        var prefix = initialForms.name.replace(/INITIAL_FORM_COUNT$/, '');

        function addForm(event) {
            // Duplicate empty form.
            var newForm = emptyForm.cloneNode(true);
            // Update all references to __prefix__ in the elements names.
            renumberForm(newForm, '__prefix__', totalForms.value);
            // Make it able to delete itself.
            newForm.querySelector('[data-formset-remove-form]').addEventListener('click', removeForm);
            // Append the new form to the formsList.
            formsList.insertAdjacentElement('beforeend', newForm);
            element.dispatchEvent(new CustomEvent('add-form.formset', {
                detail: {
                    form: newForm,
                    formset: formset
                }
            }));
            // Update the totalForms.value
            totalForms.value = Number(totalForms.value) + 1;
        }

        function getForm(target) {
            var parent = target.parentElement;
            if (parent == document) {
                return null;
            }
            if (parent == formsList) {
                return target;
            }
            return getForm(parent);
        }

        function renumberForm(form, oldValue, newValue) {
            var matchValue = prefix + oldValue.toString()
            var match = new RegExp(matchValue);
            var replace = prefix + newValue.toString();

            ['name', 'id', 'for'].forEach(function (attr) {
                form.querySelectorAll('[' + attr + '*=' + matchValue + ']').forEach(function (el) {
                    el.setAttribute(attr, el.getAttribute(attr).replace(match, replace));
                });
            });

            element.dispatchEvent(new CustomEvent('renumber-form.formset', {
                detail: {
                    form: form,
                    oldValue: oldValue,
                    newValue: newValue,
                    formset: formset
                }
            }));
        }

        function removeForm(event) {
            // Find the form "row": the child of formsList that is the parent of the element
            // that triggered this event.
            var formToRemove = getForm(event.target);
            // Renumber the rows that come after us.
            var nextElement = formToRemove.nextElementSibling;
            var nextElementIndex = Array.prototype.indexOf.call(formsList.children, formToRemove);
            while (nextElement) {
                renumberForm(nextElement, nextElementIndex + 1, nextElementIndex);
                nextElement = nextElement.nextElementSibling;
                nextElementIndex = nextElementIndex + 1;
            }
            // Remove this row.
            formToRemove.remove();
            element.dispatchEvent(new CustomEvent('remove-form.formset', {
                detail: {
                    form: formToRemove,
                    formset: formset
                }
            }));
            // Decrement the management form's count.
            totalForms.value = Number(totalForms.value) - 1;
        }

        element.querySelector('[data-formset-add-form]').addEventListener('click', addForm);
        element.formset = this;

        element.dispatchEvent(new CustomEvent('init.formset', {
            detail: {
                formset: this
            }
        }));

        this.addForm = addForm;
    }

    new Formset(document.querySelector('#demo'));

</script>
</body>
</html>